<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>How to Listen on the Wallet State Changes in MetaMask in 2021 | Atlas' Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><meta name="generator" content="Hexo 4.2.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">How to Listen on the Wallet State Changes in MetaMask in 2021</h1><a id="logo" href="/.">Atlas' Blog</a><p class="description">三七的深夜食堂</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">How to Listen on the Wallet State Changes in MetaMask in 2021</h1><div class="post-meta">Dec 25, 2020</div><a class="disqus-comment-count" data-disqus-identifier="2020/12/25/how-to-listen-on-the-wallet-state-changes-in-metamask-in-2021/" href="/2020/12/25/how-to-listen-on-the-wallet-state-changes-in-metamask-in-2021/#disqus_thread"></a><div class="post-content"><p>There are two very common wallet state changes needed to handle: chainId(network) and account changes. It’s a very typical pattern to dynamically detect the current active user and chainId at the time of writing any non-trivial application. This article will introduce how to decently listen on these changes.</p>
<p>To manage it, we need to use two API calls:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># From https:&#x2F;&#x2F;eips.ethereum.org&#x2F;EIPS&#x2F;eip-1193#events</span><br><span class="line">Provider.on(&#39;chainChanged&#39;, listener: (chainId: string) &#x3D;&gt; void): Provider;</span><br><span class="line">Provider.on(&#39;accountsChanged&#39;, listener: (accounts: string[]) &#x3D;&gt; void): Provider;</span><br></pre></td></tr></table></figure>

<p>Since to connect MetaMask, we can use the <code>window.ethereum</code> as our <code>provider</code>, so to listen on the state changes, here’s a sample code:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">let that &#x3D; this</span><br><span class="line">window.ethereum.on(&#39;accountsChanged&#39;, function (accounts) &#123;</span><br><span class="line">  console.log(&#96;Accounts changed. All connected accounts are: $&#123;accounts&#125;&#96;)</span><br><span class="line">  if (accounts.length &#x3D;&#x3D; 0) &#123;</span><br><span class="line">    console.log(&#96;All accounts disconnected.&#96;)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    that.userAddr &#x3D; accounts[0] &#x2F;&#x2F; current active user</span><br><span class="line">    console.log(&#96;Currently the active user is $&#123;accounts[0]&#125;&#96;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">window.ethereum.on(&#39;chainChanged&#39;, (chainId) &#x3D;&gt; &#123;</span><br><span class="line">  console.log(&#96;ChainId changes. Current connected chainId is $&#123;chainId&#125;&#96;)</span><br><span class="line">  if (chainId &#x3D;&#x3D; correctChainId) &#123;</span><br><span class="line">    console.log(&#96;You are in the correct network.&#96;)</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    console.log(&#96;You are in the wrong network. Please switch to the network with chainId $&#123;chainId&#125;&#96;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>Specifically, <code>let that = this</code> is just a small programming tip, yet very useful if there’s a context switch. But definitely you might not need that tip at all, just follow your own application logic!</p>
<p>The <code>accountsChanged</code> listener can be triggered if the number of connected accounts from 0 to some amount, or from some amount to 0, also it can be triggered if the current active user changes. Whereas the <code>chainChanged</code> listener can be triggered if the current connected network changes. But just to notice, both the listeners will not be triggered during the loading of the page, which means, if MetaMask has been enabled and some account has been connected to this site, reloading the page will not trigger the listeners.</p>
<p>So to summarize, according to the features of the two listeners introduced above, here I introduce a complete pattern I used in my application:</p>
<p>Once the page is loaded:</p>
<ol>
<li><p>At the very beginning we need to create two listeners on <code>accountsChanged</code> and <code>chainChanged</code> respectively, and in their handlers according to the application logic, I just do a little computations and modified a small amount of meaningful variables, which will be listened on out of the listeners, and there I will do the major computations.(Typically if you use some frameworks, like React, Vue, etc, it can be easily done.)</p>
</li>
<li><p>Then we need to check the current active account and the connected chainId and handle the different scenarios.</p>
</li>
</ol>
<p>Besides, if the dapp forces to connect the MetaMask once it’s loaded, we can implement the 3rd step just immediate after the above logic, otherwise simply put it in its correct position (mostly it’s supposed to be a click handler).</p>
<ol start="3">
<li>Then we deal with the connect logic. I introduce to how connect MetaMask in a previous <a href="https://atlasquan.github.io/2020/12/25/how-to-connect-web3-js-to-metamask-in-2021/">article</a> in detail. In this step, we only need to handle the logic about connection to MetaMask, and we don’t need to know which accounts are finally connected or which network is switched, since we have the separate listeners above to handle such things.</li>
</ol>
</div><div class="tags"><a href="/tags/Blockchain/">Blockchain</a></div><div class="post-nav"><a class="pre" href="/2020/12/26/fence/">栅栏</a><a class="next" href="/2020/12/25/how-to-connect-web3-js-to-metamask-in-2021/">How to Connect Web3.js to MetaMask in 2021</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://atlasquan.github.io/2020/12/25/how-to-listen-on-the-wallet-state-changes-in-metamask-in-2021/';
    this.page.identifier = '2020/12/25/how-to-listen-on-the-wallet-state-changes-in-metamask-in-2021/';
    this.page.title = 'How to Listen on the Wallet State Changes in MetaMask in 2021';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//Atlas.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//Atlas.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://Atlas.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://atlasquan.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/USB/" style="font-size: 15px;">USB</a> <a href="/tags/Misc/" style="font-size: 15px;">Misc</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Open-Source/" style="font-size: 15px;">Open Source</a> <a href="/tags/Poem/" style="font-size: 15px;">Poem</a> <a href="/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/" style="font-size: 15px;">读书笔记</a> <a href="/tags/Chitchat/" style="font-size: 15px;">Chitchat</a> <a href="/tags/Tablet/" style="font-size: 15px;">Tablet</a> <a href="/tags/%E4%BA%92%E8%81%94%E7%BD%91/" style="font-size: 15px;">互联网</a> <a href="/tags/Blockchain/" style="font-size: 15px;">Blockchain</a> <a href="/tags/Embedded/" style="font-size: 15px;">Embedded</a> <a href="/tags/Nucleo/" style="font-size: 15px;">Nucleo</a> <a href="/tags/%E8%87%AA%E8%AF%91/" style="font-size: 15px;">自译</a> <a href="/tags/Security/" style="font-size: 15px;">Security</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/10/17/anxiety-about-money/">当我在为钱焦虑的时候我在焦虑什么</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/09/27/human/">人可生如蝼蚁而美如神</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/06/05/commit-my-heart/">献出心脏 直到高墙倒塌</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/03/08/toher/">给她</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/26/fence/">栅栏</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/25/how-to-listen-on-the-wallet-state-changes-in-metamask-in-2021/">How to Listen on the Wallet State Changes in MetaMask in 2021</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/12/25/how-to-connect-web3-js-to-metamask-in-2021/">How to Connect Web3.js to MetaMask in 2021</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/11/09/fuck-subscription/">使用Firefox轻松绕过订阅付费墙（无需安装插件）</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/09/03/sanhe/">三和市场——“黑色”桃花源 |《岂不怀归：三和青年调查》书评</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/08/22/format-usb/">Linux下U盘无法挂载</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://coder109.github.io/" title="幻" target="_blank">幻</a><ul></ul><a href="https://printem.pw/" title="半吊子全栈开发者的日常" target="_blank">半吊子全栈开发者的日常</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">Atlas' Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>